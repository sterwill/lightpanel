#!/bin/sh
#
# A total hack to convert the W3C image map files that GIMP creates into
# snippets of BrightScript that define the selected regions.
#
# Stick to rectangular regions (not circular or irregular).  I don't know 
# what happens if regions overlap.

set -e

OUT=`dirname $0`/../source/screens/_sprites.brs

echo "Generating $OUT"
echo "' This file was automatically generated by \"generate\" from image map data." > "$OUT"
echo "' It contains functions that create sprites for each machine type." >> "$OUT"

for MAPFILE in *.map ; do
    LINES=`grep "<area shape" $MAPFILE | sed -e "s/.*coords=\"//g" | sed -e "s/\".*$//g"`
    TOTAL=0
    for LINE in $LINES ; do
      TOTAL=$((TOTAL+1))
    done

    BASE=`basename $MAPFILE .xcf.map`
    MODEL=`echo $BASE | cut -f 1 -d -`
    RESOLUTION=`echo $BASE | cut -f 2 -d -`
    
    echo "" >> "$OUT"
    echo "' $MAPFILE" >> "$OUT" 
    echo "function ${MODEL}_create_${RESOLUTION}_sprites(overlay, compositor) as object" >> "$OUT"
    echo "    dim regions[$((TOTAL-1))]" >> "$OUT"
    echo "    dim sprites[$((TOTAL-1))]" >> "$OUT"
    COUNT=0
    for LINE in $LINES ; do
       X1=`echo $LINE | cut -d , -f 1` 
       Y1=`echo $LINE | cut -d , -f 2` 
       X2=`echo $LINE | cut -d , -f 3` 
       Y2=`echo $LINE | cut -d , -f 4` 
       WIDTH=$(($X2-$X1))
       HEIGHT=$(($Y2-$Y1))
    
       echo "    regions[$((COUNT))] = CreateObject(\"roRegion\", overlay, $X1, $Y1, $WIDTH, $HEIGHT)" >> "$OUT"
       echo "    sprites[$((COUNT))] = m.compositor.NewSprite($X1, $Y1, regions[$((COUNT))], 1)" >> "$OUT"
    
       COUNT=$((COUNT+1))
    done
    echo "    return sprites" >> "$OUT"
    echo "end function" >> "$OUT"
done